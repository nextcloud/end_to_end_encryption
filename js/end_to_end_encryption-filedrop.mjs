import{z as d,j as l,A as c,C as F,n as m,D as E,l as s,v as x,e as U,E as K,t as R,F as G,G as f,i as w,w as b,k as M,H as A,I as C,m as k,J as B,K as Z,y as h,L as H}from"./NcTextField.vue_vue_type_script_setup_true_lang-cbNqV44E-CW99GoBs.chunk.mjs";import{_ as D,N as j,a as J,s as I}from"./index-hZPKu-D6-B_XOuwC5.chunk.mjs";import{X as Y,M as q}from"./x509.es-86nvmWKJ.chunk.mjs";const i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));function Q(e,t=0){return(i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]).toLowerCase()}let _;const W=new Uint8Array(16);function X(){if(!_){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");_=crypto.getRandomValues.bind(crypto)}return _(W)}const ee=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),N={randomUUID:ee};function te(e,t,n){e=e||{};const r=e.random??e.rng?.()??X();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Q(r)}function ne(e,t,n){return N.randomUUID&&!e?N.randomUUID():te(e)}const re={name:"AlertCircleIcon",emits:["click"],props:{title:{type:String},fillColor:{type:String,default:"currentColor"},size:{type:Number,default:24}}},oe=["aria-hidden","aria-label"],ie=["fill","width","height"],ae={d:"M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"},le={key:0};function se(e,t,n,r,o,a){return l(),d("span",E(e.$attrs,{"aria-hidden":n.title?null:"true","aria-label":n.title,class:"material-design-icon alert-circle-icon",role:"img",onClick:t[0]||(t[0]=y=>e.$emit("click",y))}),[(l(),d("svg",{fill:n.fillColor,class:"material-design-icon__svg",width:n.size,height:n.size,viewBox:"0 0 24 24"},[c("path",ae,[n.title?(l(),d("title",le,m(n.title),1)):F("",!0)])],8,ie))],16,oe)}const ce=D(re,[["render",se]]),pe={name:"CheckIcon",emits:["click"],props:{title:{type:String},fillColor:{type:String,default:"currentColor"},size:{type:Number,default:24}}},de=["aria-hidden","aria-label"],ue=["fill","width","height"],ye={d:"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"},fe={key:0};function he(e,t,n,r,o,a){return l(),d("span",E(e.$attrs,{"aria-hidden":n.title?null:"true","aria-label":n.title,class:"material-design-icon check-icon",role:"img",onClick:t[0]||(t[0]=y=>e.$emit("click",y))}),[(l(),d("svg",{fill:n.fillColor,class:"material-design-icon__svg",width:n.size,height:n.size,viewBox:"0 0 24 24"},[c("path",ye,[n.title?(l(),d("title",fe,m(n.title),1)):F("",!0)])],8,ue))],16,de)}const me=D(pe,[["render",he]]);function p(e){return btoa(String.fromCharCode(...new Uint8Array(e)))}async function ge(e,t){const n=await _e(JSON.stringify(e));s.debug(`[FileDrop] Encryption info compressed (${e.filename})`,{encryptionInfo:e,compressedEncryptionInfo:n});const r=await v(),{content:o,tag:a}=await T(r,new Uint8Array(n));return s.debug(`[FileDrop] Encryption info encrypted (${e.filename})`,{content:o,tag:a,encryptionParams:r}),s.debug(`[FileDrop] Encryption info base64ed (${e.filename})`,{ciphertext:p(o)}),{ciphertext:p(o),nonce:p(r.initializationVector),authenticationTag:p(a),users:await De(t,r)}}async function we(e,t,n,r){const o=x("apps/end_to_end_encryption/api/v{encryptionVersion}/meta-data/{folderId}",{encryptionVersion:e,folderId:t}),{data:{ocs:{meta:a}}}=await U.put(`${o}/filedrop`,{filedrop:JSON.stringify(n)},{headers:{"x-e2ee-supported":!0},params:{shareToken:r}});if(a.statuscode!==200)throw new Error(`Failed to upload metadata: ${a.message}`)}async function _e(e){const t=new Blob([e]).stream().pipeThrough(new CompressionStream("gzip")),n=[],r=t.getReader();for(;;){const{value:o}=await r.read();if(o===void 0)break;n.push(o)}return new Uint8Array(await new Blob(n).arrayBuffer())}async function De(e,t){return Promise.all(Object.entries(e).map(async([n,r])=>{const o=await window.crypto.subtle.exportKey("raw",t.key),a=await Ie(r,o);return{userId:n,encryptedFiledropKey:p(a)}}))}function be(e){return e.slice(e.byteLength-16)}async function Ae(){return await window.crypto.subtle.generateKey({name:"AES-GCM",length:128},!0,["encrypt","decrypt"])}async function v(){return{key:await Ae(),initializationVector:window.crypto.getRandomValues(new Uint8Array(16))}}async function T({key:e,initializationVector:t},n){const r=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:t},e,n);return{content:r,tag:be(r)}}async function Ce(e){const t=await e.arrayBuffer(),n=await v(),{content:r,tag:o}=await T(n,new Uint8Array(t));return s.debug(`[FileDrop] File encrypted: ${e.name}`,{file:e,content:r,tag:o,encryptionParams:n,rawKey:p(await window.crypto.subtle.exportKey("raw",n.key))}),{encryptedFileContent:r,encryptionInfo:{filename:e.name,mimetype:e.type||"application/octet-stream",nonce:p(n.initializationVector),key:p(await window.crypto.subtle.exportKey("raw",n.key)),authenticationTag:p(o)}}}async function ke(e){const t=new Y(e);return await window.crypto.subtle.importKey("spki",t.publicKey.rawData,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"])}async function Ie(e,t){return await window.crypto.subtle.encrypt({name:"RSA-OAEP"},await ke(e),t)}async function Ne(e,t,n,r){await U.put(q.join(K(),e,t),n,{headers:{Authorization:`Basic ${btoa(`${r}:`)}`}})}const u={NONE:"none",ENCRYPTING:"encrypting",UPLOADING:"uploading",UPLOADED:"uploaded",UPLOADING_METADATA:"uploading_metadata",DONE:"done"},Fe={name:"FileDrop",components:{NcContent:J,NcAppContent:j,NcLoadingIcon:G,IconCheck:me,IconAlertCircle:ce},data(){return{shareToken:h("end_to_end_encryption","token"),folderId:h("end_to_end_encryption","fileId"),publicKeys:h("end_to_end_encryption","publicKeys"),fileName:h("end_to_end_encryption","fileName"),encryptionVersion:Number.parseInt(h("end_to_end_encryption","encryptionVersion")),uploadedFiles:[],loading:!1,UploadStep:u,highlightDropZone:!1}},methods:{handleDragOver(e){e.dataTransfer?.types.includes("Files")&&(e.dataTransfer.dropEffect="copy",this.highlightDropZone=!0)},handleDrop(e){e.dataTransfer?.types.includes("Files")&&(this.filesChange(e.dataTransfer.files),this.highlightDropZone=!1)},async filesChange(e){if(!e?.length||this.loading)return;this.loading=!0;let t=[];try{t=await Promise.all(Array.from(e).map(n=>this.uploadFile(n))),s.debug("[FileDrop] Files uploaded",{progresses:t})}catch(n){s.error("[FileDrop] Error while uploading files",{exception:n}),I(this.t("end_to_end_encryption","Error while uploading files"));for(const r of t)r.error=!0}try{t.filter(({error:r})=>!r).forEach(r=>{r.step=u.UPLOADING_METADATA});const n=t.filter(({error:r})=>!r).reduce((r,{fileDrop:o})=>({...r,...o}),{});s.debug("[FileDrop] FileDrop entries computed",{fileDrops:n}),await we(this.encryptionVersion,this.folderId,n,this.shareToken)}catch(n){s.error("[FileDrop] Error while uploading metadata",{exception:n}),I(this.t("end_to_end_encryption","Error while uploading metadata"));for(const r of t)r.error=!0}t.filter(({error:n})=>!n).forEach(n=>{n.step=u.DONE}),this.loading=!1},async uploadFile(e){const t={file:e,step:u.NONE,error:!1,fileDrop:{}};this.uploadedFiles.push(t);try{t.step=u.ENCRYPTING;const{encryptedFileContent:n,encryptionInfo:r}=await Ce(e),o=ne().replaceAll("-","");t.fileDrop[o]=await ge(r,this.publicKeys),s.debug(`[FileDrop] Filedrop entry computed: ${e.name}`,{fileDropEntry:t.fileDrop[o]}),t.step=u.UPLOADING,await Ne(`/public.php/dav/files/${this.shareToken}`,o,n,this.shareToken),t.step=u.UPLOADED,s.debug(`[FileDrop] File uploaded: ${e.name}`,{encryptedFileContent:n,encryptionInfo:r,encryptedFileName:o,shareToken:this.shareToken})}catch(n){t.error=!0,s.error(`[FileDrop] Fail to upload the file (${t.step})`,{exception:n})}return t},t:R}},Ee={class:"uploader-form__label"},Ue=["disabled"],ve={class:"uploader-form__file-list"};function Te(e,t,n,r,o,a){const y=f("IconAlertCircle"),S=f("IconCheck"),L=f("NcLoadingIcon"),O=f("NcAppContent"),V=f("NcContent");return l(),w(V,{"app-name":"end_to_end_encryption"},{default:b(()=>[M(O,{onDrop:A(a.handleDrop,["prevent"]),onDragover:A(a.handleDragOver,["prevent"]),onDragleave:t[1]||(t[1]=g=>o.highlightDropZone=!1)},{default:b(()=>[c("div",{class:C(["uploader-form",{highlight:o.highlightDropZone}])},[c("div",Ee,[t[2]||(t[2]=c("div",{class:"uploader-form__icon icon-folder"},null,-1)),k(" "+m(a.t("end_to_end_encryption","Upload encrypted files to {fileName}",{fileName:o.fileName}))+" ",1),c("label",{class:C(["uploader-form__input button primary",{loading:o.loading}])},[k(m(a.t("end_to_end_encryption","Select or drop files"))+" ",1),c("input",{type:"file",multiple:"",disabled:o.loading,onChange:t[0]||(t[0]=g=>a.filesChange(g.target?.files))},null,40,Ue)],2)]),c("ul",ve,[(l(!0),d(B,null,Z(o.uploadedFiles,({file:g,step:$,error:z},P)=>(l(),d("li",{key:P,class:"uploader-form__file-list__item"},[z?(l(),w(y,{key:0,size:20})):$===o.UploadStep.DONE?(l(),w(S,{key:1,size:20})):(l(),w(L,{key:2})),c("b",null,m(g.name),1)]))),128))])],2)]),_:1},8,["onDrop","onDragover"])]),_:1})}const Se=D(Fe,[["render",Te],["__scopeId","data-v-2fffc04c"]]),Le=H(Se);Le.mount("#content");
//# sourceMappingURL=end_to_end_encryption-filedrop.mjs.map
